{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>TurboPDF</title>
    <link rel="stylesheet" href="{%static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{%static 'css/style.css' %}">
            <style>
                #pdf-container {
                    width: 100%;
                    height: 600px;
                }
            
                .btn-primary {
                    margin-bottom: 5px;
                    background-color: #2A3944ff;
                    border-color: black;
            
                }
            </style>

    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>

</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">TurboPDF</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/appendPdf">Joindre</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/compressPdf/">Compresser</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/fillFormPdf/">Remplir un formulaire</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/addImage/">Ajouter une image</a>
    
                    </li>
                    <li>
                        <a class="nav-link" href="/lockPdf/">Verrouiller</a>
                    </li>
                    <li>
                        <a class="nav-link" href="/unlockPdf/">
                            Deverrouiller
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="/deletePagePdf/">
                            Supprimer
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="/splitPdf/">
                            Extraire
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div id="app">
        <h2>Extraire une ou plusieurs page(s) d'un PDF</h2>
        <form id="pdf-upload-form">
            <input type="file" id="pdf-upload" name="pdf-upload" accept=".pdf" value="upload">
            <button class="btn btn-primary" type="submit">Afficher</button>

        </form>
            <div>
            <fieldset>
                <div>
                <input type="radio" id="single" name="choice" value="single">
                <label for="single">Une page</label>
                    <select id="page_number" name="page_number">
                    </select>
                </div>
                <div>
                    <input type="radio" id="range" name="choice" value="range">
                    <label for="range">Un ensemble :</label>
                    <span>a partir de la page </span>
                    <select id="page_range_start" name="page_range_start">
                    </select>
                    <span>jusqu'a </span>
                    <select id="page_range_end" name="page_range_end">
                    </select>
                </div>
            </fieldset>
            </div>
            <button class="btn btn-primary" id="extract-pdf">Extraire</button>

        <button class="btn btn-primary" id="previous-page">Précédent</button>
        <div id="current-page-number">0</div>
        <button class="btn btn-primary" id="next-page">Suivant</button>

        <style>
            #previous-page, #next-page, #current-page-number {
                display: none;
            }
        </style>
    </div>
    <div id="pdf-container"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';

        let pdfDoc;
        let numPage;
        let currentPageNumber = 1; // Variable pour suivre le numéro de page actuel

        function renderPage(pageNumber) {
            pdfDoc.getPage(pageNumber).then(function (page) {
                var viewport = page.getViewport({scale: 1});
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                page.render({canvasContext: context, viewport: viewport}).promise.then(function () {
                });
            });
        }

        // Fonction pour mettre à jour les options des listes déroulantes en fonction du nombre total de pages
        function updateSelectOptions() {
            const pageSelect = document.getElementById('page_number');
            const pageRangeStartSelect = document.getElementById('page_range_start');
            const pageRangeEndSelect = document.getElementById('page_range_end');

            pageSelect.innerHTML = ''; // Supprimer les anciennes options
            pageRangeStartSelect.innerHTML = '';
            pageRangeEndSelect.innerHTML = '';

            for (let i = 1; i <= numPage; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = i;
                pageSelect.appendChild(option);

                const optionStart = document.createElement('option');
                optionStart.value = i;
                optionStart.text = i;
                pageRangeStartSelect.appendChild(optionStart);

                const optionEnd = document.createElement('option');
                optionEnd.value = i;
                optionEnd.text = i;
                pageRangeEndSelect.appendChild(optionEnd);
            }
        }

        // Fonction pour afficher la page spécifiée
        function displayPage(pageNumber) {
            renderPage(pageNumber);
            updatePageNumber(pageNumber);
        }

        function showNavigation() {
            const previousPageButton = document.getElementById('previous-page');
            const nextPageButton = document.getElementById('next-page');
            const currentPageNumberDiv = document.getElementById('current-page-number');
            previousPageButton.style.display = 'inline-block';
            nextPageButton.style.display = 'inline-block';
            currentPageNumberDiv.style.display = 'inline-block';
        }

        // Fonction pour mettre à jour l'affichage du numéro de page
        function updatePageNumber(pageNumber) {
            const pageNumberElement = document.getElementById('current-page-number');
            pageNumberElement.textContent = pageNumber;
        }

        document.getElementById('pdf-upload-form').addEventListener('submit', function (e) {
            e.preventDefault();
            var fileInput = document.getElementById('pdf-upload');
            var file = fileInput.files[0];

            if (file && file.type === 'application/pdf') {
                var fileReader = new FileReader();
                fileReader.onload = function (e) {
                    var pdfData = new Uint8Array(e.target.result);


                    // Chargement du PDF avec PDF.js
                    pdfjsLib.getDocument({data: pdfData}).promise.then(function (pdf) {

                        pdfDoc = pdf;
                        numPage = pdfDoc.numPages;
                        updateSelectOptions();

                        canvas = document.createElement('canvas');
                        context = canvas.getContext('2d');
                        canvas.style.display = 'block';
                        canvas.style.margin = 'auto';
                        canvas.setAttribute("id", "Mycanvas");
                        document.getElementById('pdf-container').innerHTML = '';
                        document.getElementById('pdf-container').appendChild(canvas);

                        // Afficher la première page lors du chargement du PDF
                        displayPage(currentPageNumber);
                        showNavigation();
                    });
                };
                fileReader.readAsArrayBuffer(file);
            } else {
                console.log('Veuillez sélectionner un fichier PDF valide !');
            }
        });

        // Événement pour le bouton "suivant"
        document.getElementById('next-page').addEventListener('click', function () {
            if (currentPageNumber < numPage) {
                displayPage(currentPageNumber + 1);
                currentPageNumber += 1;
            }
            else if (currentPageNumber == numPage) {
                currentPageNumber = 1;
                displayPage(currentPageNumber)
            }
        });

        // Événement pour le bouton "précédent"
        document.getElementById('previous-page').addEventListener('click', function () {
            if (currentPageNumber > 1) {
                displayPage(currentPageNumber - 1);
                currentPageNumber -= 1;
            }
            else if (currentPageNumber == 1) {
                currentPageNumber = numPage;
                displayPage(currentPageNumber);
            }
        });


        function extractAndDownloadPDF() {
            const choiceSingle = document.getElementById('single').checked;
            const choiceRange = document.getElementById('range').checked;
            let pageNumber;
            let pageRangeStart;
            let pageRangeEnd;

            if (choiceSingle) {
                pageNumber = parseInt(document.getElementById('page_number').value);
                if (!pageNumber || pageNumber < 1 || pageNumber > numPage) {
                    alert('Veuillez sélectionner un numéro de page valide.');
                    return;
                }

                // Extraire et télécharger la page sélectionnée
                pdfDoc.getPage(pageNumber).then(function (page) {
                    var pdf = new jsPDF();
                    var viewport =  page.getViewport({scale: 1});
                    var canvas = document.createElement('canvas');
                    var context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    page.render({ canvasContext: context, viewport: viewport }).promise.then(function () {
                        var imgData = canvas.toDataURL('image/png');
                        pdf.addImage(imgData, 'PNG', 0, 0, viewport.width, viewport.height);
                        pdf.save('page_' + pageNumber + '.pdf');
                    });
                });
            } else if (choiceRange) {
                pageRangeStart = parseInt(document.getElementById('page_range_start').value);
                pageRangeEnd = parseInt(document.getElementById('page_range_end').value);
                if (!pageRangeStart || !pageRangeEnd || pageRangeStart < 1 || pageRangeEnd > numPage || pageRangeStart > pageRangeEnd) {
                    alert('Veuillez sélectionner une plage de pages valide.');
                    return;
                }

                // Extraire et télécharger l'ensemble de pages
                var pdf = new jsPDF();
                for (let i = pageRangeStart; i <= pageRangeEnd; i++) {
                    pdfDoc.getPage(i).then(function (page) {
                        var scale = 1.5;
                        var viewport = page.getViewport({ scale });
                        var canvas = document.createElement('canvas');
                        var context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        page.render({ canvasContext: context, viewport: viewport }).promise.then(function () {
                            var imgData = canvas.toDataURL('image/png');
                            if (i !== pageRangeStart) {
                                pdf.addPage();
                            }
                            pdf.addImage(imgData, 'PNG', 0, 0, viewport.width, viewport.height);
                            if (i === pageRangeEnd) {
                                pdf.save('page_range_' + pageRangeStart + '_to_' + pageRangeEnd + '.pdf');
                            }
                        });
                    });
                }
            }
        }

        // Événement pour le bouton "Extraire"
        document.getElementById('extract-pdf').addEventListener('click', function () {
            extractAndDownloadPDF();
        });

    </script>


</body>
</html>