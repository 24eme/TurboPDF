{% load static %}
<!DOCTYPE html>
<html>
<head>
   <title>Ajouter Image</title>
    <link rel="stylesheet" href="{%static 'css/bootstrap.min.css' %}">
  <style>
    #pdf-container {
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
       <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <a class="navbar-brand" href="/">TurboPDF</a>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="#">Comparer PDFs</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/compressPdf/">Compresser PDF</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/addImage/">Ajouter une image</a>

                        </li>
                        <li>
                            <a class="nav-link" href="/lockPdf/">Verrouiller</a>
                        </li>
                        <li>
                            <a class="nav-link" href="/unlockPdf/">
                                Deverrouiller
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
  <h1>Ajouter une image</h1>

  <form id="pdf-upload-form">
    <input type="file" id="pdf-upload" name="pdf-upload" accept=".pdf">
    <button type="submit">Afficher</button>
  </form>

  <div id="pdf-container"></div>

  <button id="add-image-btn">Ajouter une image</button>
  <button id="download-pdf-btnn">Télécharger le PDF</button>

  <!-- <div id="pdf-container">
    <canvas id="canvas"></canvas>
  </div> -->

  <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
  <script>
    var isDragging = false;
    var dragStartX = 0; // départ du déplacement
    var dragStartY = 0;
    var dragOffsetX = 0; 
    var dragOffsetY = 0; 
    var pdfDoc = null;
    var canvas = null;
    var context = null;
    var image = null;
    var pageNumber = 1;

    function renderPage(pageNumber) {
  pdfDoc.getPage(pageNumber).then(function(page) {
    var viewport = page.getViewport({ scale: 1 });
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    page.render({ canvasContext: context, viewport: viewport }).promise.then(function() {
      if (image) {
        context.drawImage(image, dragOffsetX, dragOffsetY); // Dessine l'image en utilisant les coordonnées de décalage
        
      }
    });
  });
}


    document.getElementById('pdf-upload-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var fileInput = document.getElementById('pdf-upload');
      var file = fileInput.files[0];

      if (file && file.type === 'application/pdf') {
        var fileReader = new FileReader();
        fileReader.onload = function(e) {
          var pdfData = new Uint8Array(e.target.result);

          // Chargement du PDF avec PDF.js
          pdfjsLib.getDocument({ data: pdfData }).promise.then(function(pdf) {

            pdfDoc = pdf;
            var pageNumber = 1; // Numéro de page à afficher
            numPage = pdfDoc.numPages;
            console.log("Numpage : ", numPage);

            canvas = document.createElement('canvas');
            context = canvas.getContext('2d');
            canvas.style.display = 'block';
            canvas.style.margin = 'auto';
            document.getElementById('pdf-container').innerHTML = '';
            document.getElementById('pdf-container').appendChild(canvas);

            renderPage(pageNumber);
          });
        };
        fileReader.readAsArrayBuffer(file);
      } else {
        console.log('Veuillez sélectionner un fichier PDF valide !');
      }
    });
    
    document.getElementById('add-image-btn').addEventListener('click', function(e) {
      if (pdfDoc) {
        var imageInput = document.createElement('input');
        imageInput.type = 'file';
        imageInput.accept = 'image/*';
        imageInput.addEventListener('change', function() {
          var imageFile = imageInput.files[0];

          if (imageFile && imageFile.type.includes('image/')) {
            var imageReader = new FileReader();
            imageReader.onload = function(e) {
              image = new Image();
              image.onload = function() {
                //context.clearRect(0, 0, canvas.width, canvas.height); // Efface le contenu précédent du canvas
                renderPage(1);
              };
              image.src = e.target.result;
            };
            imageReader.readAsDataURL(imageFile);
          } else {
            consoleconsole.log('Veuillez sélectionner un fichier image valide !');
          }
        });
        imageInput.click();
      }
      canvas.addEventListener('mousedown', function(e) {
  if (image) {
    isDragging = true;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
  }
});

canvas.addEventListener('mousemove', function(e) {
  if (isDragging) {
  
    var offsetX = e.clientX - dragStartX;
    var offsetY = e.clientY - dragStartY;
    dragOffsetX += offsetX;
    dragOffsetY += offsetY;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
   // context.drawImage(image, dragOffsetX, dragOffsetY);
    renderPage(numPage);
  }
});

canvas.addEventListener('mouseup', function() {
  isDragging = false;
});
    });

    document.getElementById('download-pdf-btn').addEventListener('click', function(e) {
      if (pdfDoc) {
        var imgDataUrl = canvas.toDataURL(); // Récupère les données de l'image du canvas
        var imgWidth = canvas.width;
        var imgHeight = canvas.height;

        pdfDoc.getPage(1).then(function(page) {
          var viewport = page.getViewport({ scale: 1 });
          var pdfCanvas = document.createElement('canvas');
          var pdfContext = pdfCanvas.getContext('2d');
          pdfCanvas.width = viewport.width;
          pdfCanvas.height = viewport.height;

          pdfContext.drawImage(page, 0, 0, viewport.width, viewport.height, 0, 0, pdfCanvas.width, pdfCanvas.height);
          pdfContext.drawImage(image, 0, 0, imgWidth, imgHeight); // Dessine l'image sur le canvas PDF

          var pdfDataUri = pdfCanvas.toDataURL('image/jpeg');
          var byteString = atob(pdfDataUri.split(',')[1]);
          var mimeString = pdfDataUri.split(',')[0].split(':')[1].split(';')[0];
          var ab = new ArrayBuffer(byteString.length);
          var ia = new Uint8Array(ab);
          for (var i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
          }

          var blob = new Blob([ab], { type: mimeString });
          var url = URL.createObjectURL(blob);

          var a = document.createElement('a');
          a.href = url;
          a.download = 'modified.pdf';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      } else {
        console.log('Veuillez charger un fichier PDF avant de le télécharger !');
      }
    });
  </script>
</body>
</html>
